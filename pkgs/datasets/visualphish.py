import os
import shutil
from glob import glob
from pathlib import Path

import pandas as pd

import torch
from pkgs.utils import get_first_found_file
from torchvision import transforms

from .base import BaseSplitImageDataset


class VisualPhishDataset(BaseSplitImageDataset):
    def __init__(self, root, org_folder=None, **kwargs):
        self.version = "submission"
        self.org_folder = org_folder

        super().__init__(root, **kwargs)

    def fetch(self, folder):
        trusted_brands = (
            open(
                os.path.join(self.org_folder, "trusted_list", "targets.txt"),
                "r",
            )
            .read()
            .split("\n")
        )

        # determine which targets.txt-file to use
        brands_path = get_first_found_file(
            os.path.join(self.org_folder, "phishing"),
            ["targets2.txt", "targets.txt"],
        )
        phishing_brands = open(brands_path, "r").read().split("\n")
        brands = set(trusted_brands).intersection(set(phishing_brands))

        # this brand matching is adopted from here:
        # (cell 4) https://github.com/S-Abdelnabi/VisualPhishNet/blob/51e1b7a22e18fe57bf483c043fabcfdf8349a13e/code/evaluate/Evaluate.ipynb
        brands_to_rename = {
            "ms_outlook": "microsoft",
            "ms_office": "microsoft",
            "ms_bing": "microsoft",
            "ms_onedrive": "microsoft",
            "ms_skype": "microsoft",
            "itunes": "apple",
            "icloud": "apple",
            "google_drive": "google",
            "aliexpress": "alibaba",
        }
        final_brands = brands.difference(set(brands_to_rename.keys()))
        brand_to_idx = {b: i for i, b in enumerate(final_brands)}

        files = []
        for split, group in enumerate(["phishing", "trusted_list"]):
            prefix = group[:5]
            for brand in brands:
                class_brand = (
                    brands_to_rename[brand]
                    if brand in brands_to_rename
                    else brand
                )
                b_idx = brand_to_idx[class_brand]

                for p in glob(
                    os.path.join(self.org_folder, group, brand, "*")
                ):
                    path = Path(p)
                    new = os.path.join(path.parent, f"{prefix}_{path.name}")
                    shutil.move(p, new)
                    files.append((new, b_idx, split))

        phish_train_set = set(
            [f"phish_{tr_file}" for tr_file in _phish_train_idxs]
        )
        for i, (p, b, _) in enumerate(files):
            filename = os.path.basename(p)
            if filename in phish_train_set:
                files[i] = (p, b, 1)

        df = pd.DataFrame(files, columns=["path", "label", "split_original"])

        return df


# this split were generated for the models we
# include with pretrained weights. They were
# generated from the originally implementation
# of VisualPhishNet
_phish_train_idxs = [
    "T0_0.jpg",
    "T0_1.jpg",
    "T0_3.png",
    "T0_5.png",
    "T0_6.png",
    "T0_8.png",
    "T100_0.png",
    "T103_10.png",
    "T103_12.png",
    "T103_13.png",
    "T104_0.png",
    "T105_0.png",
    "T106_0.jpg",
    "T106_3.png",
    "T106_4.png",
    "T108_1.png",
    "T108_10.png",
    "T108_102.png",
    "T108_103.png",
    "T108_108.jpg",
    "T108_110.png",
    "T108_111.png",
    "T108_112.png",
    "T108_114.png",
    "T108_117.png",
    "T108_16.png",
    "T108_17.png",
    "T108_2.jpg",
    "T108_21.png",
    "T108_23.png",
    "T108_26.png",
    "T108_28.png",
    "T108_29.png",
    "T108_3.jpg",
    "T108_31.png",
    "T108_35.png",
    "T108_36.png",
    "T108_38.png",
    "T108_39.png",
    "T108_40.png",
    "T108_47.png",
    "T108_49.png",
    "T108_5.png",
    "T108_50.png",
    "T108_51.png",
    "T108_52.png",
    "T108_53.png",
    "T108_56.png",
    "T108_62.png",
    "T108_64.png",
    "T108_69.png",
    "T108_74.jpg",
    "T108_78.png",
    "T108_79.png",
    "T108_8.png",
    "T108_81.png",
    "T108_83.jpg",
    "T108_87.jpg",
    "T108_89.png",
    "T108_90.jpg",
    "T108_92.jpg",
    "T108_94.png",
    "T108_97.png",
    "T108_98.png",
    "T109_0.jpg",
    "T10_0.png",
    "T111_0.png",
    "T112_0.png",
    "T112_2.png",
    "T113_0.png",
    "T114_0.png",
    "T117_1.png",
    "T117_2.png",
    "T11_0.png",
    "T11_3.png",
    "T121_1.png",
    "T121_2.png",
    "T122_3.png",
    "T126_0.png",
    "T12_0.png",
    "T12_10.png",
    "T12_13.png",
    "T12_14.png",
    "T12_16.png",
    "T12_18.png",
    "T12_21.png",
    "T12_24.png",
    "T12_26.png",
    "T12_27.png",
    "T12_3.png",
    "T12_32.png",
    "T12_33.png",
    "T12_37.png",
    "T12_38.png",
    "T12_4.png",
    "T12_6.png",
    "T12_9.png",
    "T134_0.png",
    "T134_1.png",
    "T136_2.png",
    "T138_0.png",
    "T138_2.png",
    "T138_6.png",
    "T138_8.png",
    "T138_9.png",
    "T13_0.png",
    "T140_1.png",
    "T140_13.png",
    "T140_14.jpg",
    "T140_16.jpg",
    "T140_19.png",
    "T140_21.jpg",
    "T140_23.png",
    "T140_25.jpg",
    "T140_27.jpg",
    "T140_34.jpg",
    "T140_5.png",
    "T140_7.png",
    "T140_9.jpg",
    "T141_1.png",
    "T144_0.jpg",
    "T144_1.jpg",
    "T144_12.png",
    "T144_16.png",
    "T144_19.png",
    "T144_26.png",
    "T144_3.jpg",
    "T144_30.png",
    "T144_34.png",
    "T144_44.jpg",
    "T144_47.png",
    "T144_49.jpg",
    "T144_50.jpg",
    "T144_51.png",
    "T144_53.png",
    "T144_57.png",
    "T144_58.png",
    "T144_60.png",
    "T144_61.png",
    "T144_63.png",
    "T144_68.png",
    "T144_7.png",
    "T144_9.png",
    "T145_1.png",
    "T147_11.png",
    "T147_12.png",
    "T147_14.png",
    "T147_15.png",
    "T147_18.png",
    "T147_2.png",
    "T147_3.png",
    "T147_4.png",
    "T147_7.png",
    "T147_8.png",
    "T149_0.jpg",
    "T149_10.png",
    "T149_13.png",
    "T149_18.png",
    "T149_19.png",
    "T149_21.png",
    "T149_22.png",
    "T149_23.png",
    "T149_26.png",
    "T149_27.png",
    "T149_3.png",
    "T149_30.png",
    "T149_31.png",
    "T14_0.jpg",
    "T14_1.jpg",
    "T150_0.png",
    "T150_11.jpg",
    "T150_13.png",
    "T150_16.png",
    "T150_19.png",
    "T150_2.png",
    "T150_20.png",
    "T150_24.png",
    "T150_29.png",
    "T150_31.png",
    "T150_32.png",
    "T150_5.png",
    "T150_9.jpg",
    "T152_0.png",
    "T152_1.png",
    "T152_10.png",
    "T152_14.jpg",
    "T152_16.jpg",
    "T152_17.png",
    "T152_18.png",
    "T152_25.png",
    "T152_26.png",
    "T152_27.png",
    "T152_29.png",
    "T152_3.png",
    "T152_30.png",
    "T152_31.png",
    "T152_32.png",
    "T152_4.png",
    "T152_5.png",
    "T152_7.png",
    "T152_8.png",
    "T153_1.png",
    "T154_0.png",
    "T15_12.png",
    "T15_6.png",
    "T15_7.png",
    "T15_9.png",
    "T17_0.png",
    "T18_0.png",
    "T19_0.jpg",
    "T19_2.png",
    "T20_0.png",
    "T21_0.png",
    "T27_0.jpg",
    "T28_0.png",
    "T29_0.png",
    "T2_0.jpg",
    "T2_1.png",
    "T2_14.png",
    "T2_15.png",
    "T2_16.png",
    "T2_19.png",
    "T2_2.png",
    "T2_21.png",
    "T2_23.png",
    "T2_24.png",
    "T2_25.png",
    "T2_27.png",
    "T2_28.png",
    "T2_30.png",
    "T2_32.png",
    "T2_4.png",
    "T2_5.png",
    "T2_8.png",
    "T30_0.jpg",
    "T30_1.jpg",
    "T30_10.png",
    "T30_13.png",
    "T30_14.png",
    "T30_15.jpg",
    "T30_2.jpg",
    "T30_22.png",
    "T30_25.jpg",
    "T30_33.jpg",
    "T30_39.png",
    "T30_4.png",
    "T30_40.png",
    "T30_6.png",
    "T30_7.png",
    "T30_8.png",
    "T30_9.png",
    "T31_0.png",
    "T31_1.png",
    "T33_1.png",
    "T34_1.png",
    "T35_0.png",
    "T36_0.png",
    "T38_0.png",
    "T39_1.png",
    "T39_10.png",
    "T39_11.jpg",
    "T39_13.png",
    "T39_15.png",
    "T39_17.jpg",
    "T39_2.jpg",
    "T39_20.png",
    "T39_30.png",
    "T39_31.png",
    "T39_32.jpg",
    "T39_34.png",
    "T39_4.png",
    "T39_9.png",
    "T3_0.png",
    "T42_1.png",
    "T43_0.png",
    "T44_0.png",
    "T45_1.png",
    "T45_4.png",
    "T45_6.png",
    "T45_7.png",
    "T47_0.png",
    "T48_0.jpg",
    "T4_14.png",
    "T4_15.png",
    "T4_16.png",
    "T4_19.png",
    "T4_21.png",
    "T4_27.png",
    "T4_3.png",
    "T4_31.png",
    "T4_34.png",
    "T4_36.png",
    "T4_39.png",
    "T4_4.png",
    "T4_40.png",
    "T4_41.jpg",
    "T4_42.jpg",
    "T4_43.png",
    "T4_44.png",
    "T4_47.png",
    "T4_48.png",
    "T4_50.png",
    "T4_52.png",
    "T4_9.png",
    "T50_1.png",
    "T50_11.png",
    "T50_15.png",
    "T50_17.png",
    "T50_18.png",
    "T50_19.png",
    "T50_23.png",
    "T50_25.png",
    "T50_26.jpg",
    "T50_27.jpg",
    "T50_28.png",
    "T50_32.jpg",
    "T50_33.png",
    "T50_36.png",
    "T50_38.png",
    "T50_40.png",
    "T50_6.png",
    "T50_8.png",
    "T51_0.png",
    "T52_0.png",
    "T53_15.png",
    "T53_19.jpg",
    "T53_2.png",
    "T53_28.png",
    "T53_3.png",
    "T53_30.png",
    "T53_31.png",
    "T53_32.png",
    "T53_33.png",
    "T53_37.png",
    "T54_2.png",
    "T54_3.png",
    "T54_7.png",
    "T54_8.png",
    "T59_100.png",
    "T59_106.png",
    "T59_107.png",
    "T59_108.png",
    "T59_111.png",
    "T59_113.png",
    "T59_116.png",
    "T59_118.png",
    "T59_12.jpg",
    "T59_120.png",
    "T59_124.png",
    "T59_125.png",
    "T59_128.png",
    "T59_129.png",
    "T59_13.png",
    "T59_14.png",
    "T59_24.png",
    "T59_25.png",
    "T59_26.png",
    "T59_29.png",
    "T59_30.png",
    "T59_32.png",
    "T59_34.png",
    "T59_38.png",
    "T59_44.png",
    "T59_51.png",
    "T59_53.png",
    "T59_63.png",
    "T59_66.png",
    "T59_69.png",
    "T59_7.jpg",
    "T59_70.png",
    "T59_74.png",
    "T59_78.jpg",
    "T59_82.png",
    "T59_84.png",
    "T59_85.png",
    "T59_86.png",
    "T59_87.png",
    "T59_9.png",
    "T59_90.png",
    "T59_93.png",
    "T59_94.png",
    "T59_96.png",
    "T59_98.jpg",
    "T60_1.png",
    "T62_0.png",
    "T63_0.png",
    "T64_1.png",
    "T65_1.jpg",
    "T65_19.png",
    "T65_24.png",
    "T65_32.png",
    "T65_34.png",
    "T65_5.png",
    "T66_0.jpg",
    "T66_3.png",
    "T66_4.png",
    "T67_0.png",
    "T68_0.png",
    "T6_7.png",
    "T6_8.png",
    "T70_0.png",
    "T71_0.jpg",
    "T72_0.png",
    "T72_1.png",
    "T72_2.png",
    "T73_4.png",
    "T74_0.png",
    "T75_2.png",
    "T75_6.png",
    "T76_0.png",
    "T76_10.png",
    "T76_11.png",
    "T76_7.png",
    "T77_3.png",
    "T77_6.png",
    "T77_8.png",
    "T79_3.png",
    "T79_4.png",
    "T7_0.jpg",
    "T7_11.png",
    "T7_16.png",
    "T7_18.png",
    "T7_2.png",
    "T7_20.png",
    "T7_21.png",
    "T7_23.jpg",
    "T7_6.png",
    "T7_8.png",
    "T83_0.png",
    "T84_10.png",
    "T84_11.png",
    "T84_14.png",
    "T84_16.jpg",
    "T84_17.jpg",
    "T84_21.png",
    "T84_25.png",
    "T84_3.jpg",
    "T84_4.png",
    "T84_6.png",
    "T84_7.png",
    "T86_0.jpg",
    "T86_1.png",
    "T86_2.png",
    "T86_4.png",
    "T86_6.png",
    "T88_1.jpg",
    "T8_1.png",
    "T90_109.png",
    "T90_112.png",
    "T90_12.png",
    "T90_124.png",
    "T90_128.png",
    "T90_130.png",
    "T90_138.png",
    "T90_139.png",
    "T90_14.png",
    "T90_143.png",
    "T90_144.png",
    "T90_2.png",
    "T90_25.png",
    "T90_44.png",
    "T90_5.png",
    "T90_58.png",
    "T90_75.png",
    "T90_77.png",
    "T90_8.png",
    "T90_81.png",
    "T92_1.png",
    "T95_0.png",
    "T95_2.png",
    "T97_0.png",
    "T98_0.jpg",
    "T98_2.png",
    "T98_4.png",
    "T98_5.png",
    "T99_0.png",
    "T9_0.png",
    "T9_1.png",
]
